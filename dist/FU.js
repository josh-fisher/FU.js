// FU.js r1 (02/17/2012) - FU.js
(function(b,j){function i(a){var b="";switch(a.code){case FileError.QUOTA_EXCEEDED_ERR:b="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:b="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:b="SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:b="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:b="INVALID_STATE_ERR";break;default:b="Unknown Error"}console.log("Error: "+b)}function u(a){console.log("File Loaded: "+a)}function n(a){console.log("File Saved To Local FileSystem: "+
a)}function v(){console.log("There was an error reading the file")}function w(){}function x(){}function o(){console.log("There was an error writing the file")}function p(){console.log("File Save Progress Update!!")}function y(){console.log("File Write Cancelled by User")}b.LOAD_MECHANISM={FILE:"file",FILESYSTEM:"filesystem",XHR:"xhr",WEBWORKER:"webworker"};b.FILE_TYPE={TXT:"txt",BINARY:"binary"};b.CLIENT_FEATURES={Workers:!1,InlineWorkers:!1,FilesystemAPI:!1,FileAPI:!1,XHR:!1};if(window.Worker)b.CLIENT_FEATURES.Workers=
!0;if(window.Worker&&(window.MozBlobBuilder||window.WebKitBlobBuilder)&&(window.webkitURL||window.URL))window.BlobBuilder=window.MozBlobBuilder||window.WebKitBlobBuilder,b.CLIENT_FEATURES.InlineWorkers=!0;if(window.File&&window.FileReader&&window.FileList&&window.Blob)b.CLIENT_FEATURES.FileAPI=!0;if((window.requestFileSystem||window.webkitRequestFileSystem)&&(window.MozBlobBuilder||window.WebKitBlobBuilder)&&(window.webkitURL||window.URL))window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,
window.BlobBuilder=window.MozBlobBuilder||window.WebKitBlobBuilder,b.CLIENT_FEATURES.FilesystemAPI=!0;if(window.XMLHttpRequest)b.CLIENT_FEATURES.XHR=!0;b.FileSystem=j;b.TempFileSystem=j;b.LocalRoot=j;b.PersistantSize=1E7;b.TemporarySize=1E7;b.InitLocalFileSystem=function(a){function f(a){b.FileSystem=a;b.CreateDirectory("",!1,function(){});window.webkitStorageInfo.requestQuota(window.TEMPORARY,b.TemporarySize,function(a){window.requestFileSystem(window.TEMPORARY,a,e,i)},function(a){console.log("Error",
a)})}function e(g){b.TempFileSystem=g;b.CreateDirectory("",!0,function(){});a()}window.webkitStorageInfo.requestQuota(PERSISTENT,b.PersistantSize,function(a){window.requestFileSystem(PERSISTENT,a,f,i)},function(a){console.log("Error",a)})};b.LoadFile=function(a){function f(){if(!a.remoteURL)throw Error("Cannot load a remote file without a remote URL");var c=new XMLHttpRequest;c.onreadystatechange=function(){if(this.readyState==4&&this.status==200){var c;if(h===b.FILE_TYPE.BINARY){var d=this.response;
d&&(c=d)}else this.responseText!==null&&this.repsonseText!==""&&(c=a.sliceParams!==j?this.responseText.slice(a.sliceParams.startIndex,a.sliceParams.stopIndex):this.responseText);k(c)}};c.open("GET",q,!0);if(h===b.FILE_TYPE.BINARY)c.responseType="arraybuffer";c.send(null)}function e(){if(!a.file)throw Error("Cannot Load File. File parameter is not specified.");var c=new FileReader;c.onerror=n;c.onprogress=o;c.onabort=p;c.onloadend=function(a){k(a.target.result,d.name)};a.sliceParams!==j&&(d.webkitSlice?
d=d.webkitSlice(a.sliceParams.startIndex,a.sliceParams.stopIndex):d.mozSlice&&(d=d.mozSlice(a.sliceParams.startIndex,a.sliceParams.stopIndex)));h===b.FILE_TYPE.TXT?c.readAsText(d):c.readAsBinaryString(d)}function g(){function c(b){a.returnType&&m==="fileEntry"?k(b,b.name):a.returnType&&m==="url"?k(b.toURL(),b.name):b.file(function(c){a.returnType&&m==="file"?k(c,b.name):(d=c,a.file=c,e(d))},i)}if(!a.file&&!a.localURL&&!a.fileName)throw Error("Cannot Load File. The correct parameters are not specified.");
var h;h=r?b.TempFileSystem:b.FileSystem;if(a.file)h.root.getFile(d.fullPath,{},function(a){c(a)},i);else if(a.localURL){var f=b.LocalRoot.concat("/"+s);h.root.getFile(f,{},function(a){c(a)},i)}else a.fileName&&b.GetFileFromFilename(t,r,function(a){c(a)})}function l(){if(!a.remoteURL)throw Error("Cannot Load File via WebWorker. Remote URL is required.");worker=new Worker(q);worker.onmessage=function(a){k(a.data)};worker.postMessage((new Date).getTime())}var h,c,q,s,t,d,r,m,k=a.loaded?a.loaded:u,n=
a.onerror?a.onerror:v,o=a.onprogress?a.onprogress:w,p=a.onabort?a.onabort:x;if(!a.fileType||!a.loadMechanism)throw Error("Cannot Load File. Filetype and loadmechanism are required parameters");else h=a.fileType,c=a.loadMechanism,r=a.temporary,q=a.remoteURL,s=a.localURL,t=a.fileName,d=a.file,m=a.returnType;switch(c){case b.LOAD_MECHANISM.FILE:e();break;case b.LOAD_MECHANISM.FILESYSTEM:g();break;case b.LOAD_MECHANISM.XHR:f();break;case b.LOAD_MECHANISM.WEBWORKER:l()}};b.SaveFile=function(a){function f(a){(l?
b.TempFileSystem:b.FileSystem).root.getFile(a,{create:!0},function(a){a.createWriter(function(b){var c=new BlobBuilder;c.append(e);b.write(c.getBlob("application/octet-stream"));b.onerror=this.onerror||o;b.onprogress=this.onprogress||p;b.onabort=this.onabort||y;b.onwriteend=function(){var b=a.toURL();h(b)}},i)},i)}var e,g,l=!1;if(a.remoteAsset===j)throw Error("Cannot Save File: "+a.filePath+" Parameters are not defined!");else e=a.remoteAsset,g=a.filePath,l=a.temporary;var h=a.saved?a.saved:n,c="/"+
b.LocalRoot+"/";l?(encodeURIComponent(e).match(/%[89ABab]/g),a=UUID.generate(),parseUri(c),a=a.concat("/"),c=c.concat(a,g),b.CreateDirectory(a,!0,function(){f(c)})):(c+=g,f(c))};b.CheckFileSystemForFile=function(a,f,e){a=b.LocalRoot.concat("/"+a);(f?b.TempFileSystem:b.FileSystem).root.getFile(a,{create:!1},function(a){e(a)},function(){e(j)})};b.CreateDirectory=function(a,f,e){a="/"+b.LocalRoot.concat("/"+a);(f?b.TempFileSystem:b.FileSystem).root.getDirectory(a,{create:!0},function(){e()},i)};b.GetFileFromFilename=
function(a,f,e){var g=function(b){b.createReader().readEntries(function(b){for(var b=Array.prototype.slice.call(b||[],0),c=0;c<b.length;c++)!b[c].isDirectory&&b[c].name===a?e(b[c]):b[c].isDirectory&&g(b[c])},i)};g((f?b.TempFileSystem:b.FileSystem).root)}})(window.FU=window.FU||{});
